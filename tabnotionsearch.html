<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigador Notion Data Sources</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .json-block {
            background-color: #1e293b;
            color: #cbd5e1;
            font-family: 'Courier New', Courier, monospace;
        }
        /* Loading Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-magnifying-glass-chart"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800 leading-tight">Investigador Notion</h1>
                    <p class="text-xs text-slate-500">Mapeador de Data Sources & Propriedades</p>
                </div>
            </div>
            <div class="hidden md:flex items-center gap-2 text-xs bg-amber-50 text-amber-800 px-3 py-1 rounded border border-amber-200">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span>Requer extensão CORS ou Proxy para funcionar Live</span>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-6xl mx-auto px-4 py-8 w-full grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Inputs & Config -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- Step 1: Upload JSON (Optional for Context) -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                <h2 class="text-sm font-bold text-slate-400 uppercase mb-4 tracking-wide">1. Fonte de Dados Inicial</h2>
                
                <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 transition-colors cursor-pointer relative group">
                    <input type="file" id="fileInput" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <div class="space-y-2">
                        <i class="fa-solid fa-file-code text-2xl text-slate-300 group-hover:text-blue-400 transition-colors"></i>
                        <p class="text-sm font-medium text-slate-600">Carregar JSON de Consulta</p>
                        <p class="text-xs text-slate-400">Arraste ou clique (opcional)</p>
                    </div>
                </div>
                <p id="fileName" class="text-xs text-blue-600 font-semibold mt-2 text-center hidden"></p>
                <div class="mt-4">
                    <textarea id="jsonInput" placeholder="Ou cole o JSON aqui..." class="w-full h-20 p-3 border border-slate-300 rounded text-xs font-mono resize-none focus:outline-none focus:border-blue-500"></textarea>
                    <button id="processLocalBtn" class="mt-2 w-full bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold py-2 px-4 rounded transition-colors">
                        Processar Localmente
                    </button>
                </div>
            </section>

            <!-- Step 2: Live API Config -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 border-l-4 border-l-blue-500">
                <h2 class="text-sm font-bold text-slate-400 uppercase mb-4 tracking-wide flex justify-between">
                    2. Conexão API Live
                    <span class="text-blue-600 text-xs normal-case bg-blue-50 px-2 py-0.5 rounded">Recomendado</span>
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Notion API Key (Secret)</label>
                        <div class="relative">
                            <i class="fa-solid fa-key absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                            <input type="password" id="apiKey" placeholder="secret_..." class="w-full pl-8 p-2 border border-slate-300 rounded text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Database ID</label>
                        <div class="flex gap-2">
                            <input type="text" id="databaseId" placeholder="32 chars UUID" class="w-full p-2 border border-slate-300 rounded text-sm font-mono focus:outline-none focus:border-blue-500">
                            <button id="extractIdBtn" class="hidden text-xs bg-green-100 text-green-700 px-2 rounded hover:bg-green-200" title="Extrair do JSON carregado">
                                <i class="fa-solid fa-arrow-up-from-bracket"></i>
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">O ID será extraído automaticamente se você carregar um JSON válido acima.</p>
                    </div>

                    <button id="fetchLiveBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 group">
                        <i class="fa-solid fa-satellite-dish group-hover:rotate-12 transition-transform"></i>
                        Investigar Data Sources
                    </button>
                    
                    <div id="apiError" class="hidden p-3 bg-red-50 text-red-600 text-xs rounded border border-red-100"></div>
                </div>
            </section>

        </div>

        <!-- Right Column: Results -->
        <div class="lg:col-span-2 flex flex-col h-full">
            
            <!-- Controls -->
            <div class="bg-white rounded-t-xl border border-slate-200 border-b-0 p-4 flex justify-between items-center sticky top-20 z-10">
                <div class="flex gap-4 text-sm">
                    <button id="tabVisual" class="font-bold text-blue-600 border-b-2 border-blue-600 pb-4 -mb-4 px-2">Visualização</button>
                    <button id="tabJson" class="font-medium text-slate-500 hover:text-slate-700 pb-4 -mb-4 px-2 transition-colors">JSON Bruto</button>
                </div>
                <span class="text-xs font-mono text-slate-400" id="statusText">Aguardando dados...</span>
            </div>

            <!-- Content Area -->
            <div class="bg-white rounded-b-xl border border-slate-200 min-h-[500px] flex flex-col relative overflow-hidden">
                
                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-30 flex flex-col items-center justify-center hidden">
                    <div class="loader mb-3"></div>
                    <p class="text-sm font-medium text-slate-600">Consultando Notion API...</p>
                    <p class="text-xs text-slate-400 mt-1">Endpoint: GET /v1/databases/{id}</p>
                </div>

                <!-- Visual View -->
                <div id="viewVisual" class="p-6 space-y-6 flex-grow">
                    <div class="text-center text-slate-400 py-12">
                        <i class="fa-regular fa-folder-open text-4xl mb-3 opacity-30"></i>
                        <p>Nenhuma propriedade carregada.</p>
                    </div>
                </div>

                <!-- JSON View -->
                <div id="viewJson" class="hidden flex-grow relative">
                    <textarea id="rawOutput" class="w-full h-full p-4 bg-slate-900 text-slate-300 font-mono text-xs resize-none focus:outline-none" readonly></textarea>
                </div>
            </div>

        </div>

    </main>

    <script>
        // --- State & DOM ---
        const state = {
            properties: {},
            databaseId: '',
            apiKey: ''
        };

        const dom = {
            fileInput: document.getElementById('fileInput'),
            fileName: document.getElementById('fileName'),
            jsonInput: document.getElementById('jsonInput'),
            processLocalBtn: document.getElementById('processLocalBtn'),
            apiKey: document.getElementById('apiKey'),
            databaseId: document.getElementById('databaseId'),
            extractIdBtn: document.getElementById('extractIdBtn'),
            fetchLiveBtn: document.getElementById('fetchLiveBtn'),
            apiError: document.getElementById('apiError'),
            viewVisual: document.getElementById('viewVisual'),
            viewJson: document.getElementById('viewJson'),
            rawOutput: document.getElementById('rawOutput'),
            tabVisual: document.getElementById('tabVisual'),
            tabJson: document.getElementById('tabJson'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            statusText: document.getElementById('statusText')
        };

        // --- Event Listeners ---
        
        // Tabs
        dom.tabVisual.addEventListener('click', () => toggleTab('visual'));
        dom.tabJson.addEventListener('click', () => toggleTab('json'));

        // Local Processing
        dom.fileInput.addEventListener('change', handleFileSelect);
        dom.processLocalBtn.addEventListener('click', handleManualJson);
        dom.extractIdBtn.addEventListener('click', () => {
            if (state.databaseId) dom.databaseId.value = state.databaseId;
        });

        // Live Fetch
        dom.fetchLiveBtn.addEventListener('click', fetchFromNotion);

        // --- Logic ---

        function toggleTab(mode) {
            if (mode === 'visual') {
                dom.viewVisual.classList.remove('hidden');
                dom.viewJson.classList.add('hidden');
                dom.tabVisual.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'font-bold');
                dom.tabVisual.classList.remove('text-slate-500', 'font-medium');
                dom.tabJson.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'font-bold');
                dom.tabJson.classList.add('text-slate-500', 'font-medium');
            } else {
                dom.viewVisual.classList.add('hidden');
                dom.viewJson.classList.remove('hidden');
                dom.tabJson.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'font-bold');
                dom.tabJson.classList.remove('text-slate-500', 'font-medium');
                dom.tabVisual.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'font-bold');
                dom.tabVisual.classList.add('text-slate-500', 'font-medium');
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            dom.fileName.textContent = file.name;
            dom.fileName.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (ev) => processJson(ev.target.result);
            reader.readAsText(file);
        }

        function handleManualJson() {
            const text = dom.jsonInput.value.trim();
            if (!text) return alert("Cole um JSON válido.");
            processJson(text);
        }

        function processJson(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                
                // Try to extract Database ID from Query Result
                if (data.results && data.results.length > 0) {
                    const first = data.results[0];
                    if (first.parent && first.parent.type === 'database_id') {
                        state.databaseId = first.parent.database_id;
                        dom.extractIdBtn.classList.remove('hidden');
                        dom.databaseId.value = state.databaseId; // Auto fill
                    }
                    if (first.properties) {
                        state.properties = first.properties;
                        renderProperties(state.properties, false); // false = not live source data
                    }
                } else if (data.properties) {
                    // Maybe user uploaded the DB definition directly
                    state.properties = data.properties;
                    if (data.id) dom.databaseId.value = data.id;
                    renderProperties(state.properties, true);
                }
                
                dom.rawOutput.value = JSON.stringify(data, null, 2);
                dom.statusText.textContent = `Carregado localmente: ${Object.keys(state.properties).length} props`;

            } catch (err) {
                alert("Erro ao ler JSON: " + err.message);
            }
        }

        async function fetchFromNotion() {
            const key = dom.apiKey.value.trim();
            const dbId = dom.databaseId.value.trim();

            if (!key) return alert("Insira a API Key.");
            if (!dbId) return alert("Insira o Database ID.");

            dom.loadingOverlay.classList.remove('hidden');
            dom.apiError.classList.add('hidden');

            try {
                // Endpoint: Retrieve a database (to get schema and relations config)
                // Note: CORS will block this unless user has an extension or disabled security.
                const response = await fetch(`https://api.notion.com/v1/databases/${dbId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Notion-Version': '2025-09-03', // As requested by user
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`Erro API (${response.status}): ${errText}`);
                }

                const data = await response.json();
                state.properties = data.properties;
                
                renderProperties(state.properties, true); // true = live data with config
                dom.rawOutput.value = JSON.stringify(data, null, 2);
                dom.statusText.textContent = `Live Fetch: Sucesso (${Object.keys(state.properties).length} props)`;

            } catch (err) {
                console.error(err);
                dom.apiError.classList.remove('hidden');
                dom.apiError.innerHTML = `
                    <strong>Falha na Requisição:</strong><br>
                    ${err.message}<br><br>
                    <em class="text-slate-500">Nota: Se este erro for "NetworkError" ou "Failed to fetch", é bloqueio de CORS.
                    Use uma extensão como "Allow CORS" no Chrome/Firefox para testar essa ferramenta localmente.</em>
                `;
            } finally {
                dom.loadingOverlay.classList.add('hidden');
            }
        }

        function renderProperties(properties, isLiveSource) {
            dom.viewVisual.innerHTML = '';
            
            // Sort: Relations & Rollups first
            const sortedKeys = Object.keys(properties).sort((a, b) => {
                const typeA = properties[a].type;
                const typeB = properties[b].type;
                const priority = ['relation', 'rollup'];
                
                if (priority.includes(typeA) && !priority.includes(typeB)) return -1;
                if (!priority.includes(typeA) && priority.includes(typeB)) return 1;
                return a.localeCompare(b);
            });

            sortedKeys.forEach(key => {
                const prop = properties[key];
                const card = createCard(key, prop, isLiveSource);
                dom.viewVisual.appendChild(card);
            });
        }

        function createCard(name, prop, isLiveSource) {
            const type = prop.type;
            let dataSourceId = null;
            let dataSourceType = null; // 'standard' (relation.database_id) or 'custom' (data_sources array)

            // Logic to find Data Source ID
            if (type === 'relation' && prop.relation) {
                dataSourceId = prop.relation.database_id;
                dataSourceType = 'Relação Direta';
            } else if (type === 'rollup' && prop.rollup) {
                // Rollups point to a relation name, not ID directly in some views, 
                // but in DB definition they rely on the relation property.
                // We show the relation property name it depends on.
                dataSourceId = `Depende de: "${prop.rollup.relation_property_name}"`;
                dataSourceType = 'Rollup';
            }

            // User requested check for 'data_sources' array key specifically
            if (prop.data_sources && Array.isArray(prop.data_sources) && prop.data_sources.length > 0) {
                 // Try to grab an ID if it looks like one
                 dataSourceId = JSON.stringify(prop.data_sources);
                 dataSourceType = 'Array "data_sources" (Encontrado!)';
            }

            // Styling
            const isTarget = (type === 'relation' || type === 'rollup');
            const borderColor = isTarget ? 'border-blue-200' : 'border-slate-100';
            const bgHeader = isTarget ? 'bg-blue-50' : 'bg-slate-50';

            const div = document.createElement('div');
            div.className = `bg-white rounded-lg border ${borderColor} shadow-sm overflow-hidden`;
            
            let sourceHtml = '';
            if (dataSourceId) {
                const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}/.test(dataSourceId);
                const displayId = isUUID ? `<span class="font-mono bg-white px-1 border rounded text-blue-600 select-all cursor-pointer" onclick="navigator.clipboard.writeText('${dataSourceId}')" title="Clique para copiar">${dataSourceId}</span>` : `<span class="italic text-slate-500">${dataSourceId}</span>`;
                
                sourceHtml = `
                    <div class="mt-3 p-3 bg-blue-100/50 rounded border border-blue-200 text-sm">
                        <div class="flex items-center gap-2 text-blue-800 font-bold mb-1">
                            <i class="fa-solid fa-database"></i>
                            Fonte de Dados (${dataSourceType})
                        </div>
                        <div class="break-all text-slate-700">
                            ID: ${displayId}
                        </div>
                    </div>
                `;
            } else if (isLiveSource && isTarget && !dataSourceId) {
                 sourceHtml = `
                    <div class="mt-3 p-2 bg-amber-50 rounded border border-amber-200 text-xs text-amber-800">
                        <i class="fa-solid fa-circle-question"></i> ID da fonte não encontrado na estrutura padrão. Verifique o JSON Bruto.
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="${bgHeader} px-4 py-3 flex justify-between items-center border-b ${borderColor}">
                    <h3 class="font-bold text-slate-700 text-sm md:text-base truncate" title="${name}">${name}</h3>
                    <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded-full ${isTarget ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-500'}">${type}</span>
                </div>
                <div class="p-4">
                    ${sourceHtml}
                    
                    <details class="mt-3 group">
                        <summary class="text-xs text-slate-400 cursor-pointer hover:text-blue-500 flex items-center gap-1 select-none">
                            <i class="fa-solid fa-code"></i> Ver JSON da Propriedade
                        </summary>
                        <pre class="mt-2 p-3 bg-slate-800 text-green-400 rounded text-[10px] overflow-x-auto font-mono leading-tight">${JSON.stringify(prop, null, 2)}</pre>
                    </details>
                </div>
            `;
            
            return div;
        }

    </script>
</body>
</html>