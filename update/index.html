<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincronizador Inteligente - Comparação por Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .fa-spinner { animation: spin 1s linear infinite; }
        
        /* Cores de Status */
        .status-updated { color: #10b981; } /* Verde - Local é atual */
        .status-outdated { color: #f59e0b; } /* Laranja - Local é velho */
        .status-error { color: #ef4444; }   /* Vermelho - Erro */

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen p-6">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-blue-400 mb-2">
                <i class="fa-solid fa-sync mr-2"></i> Sincronizador Inteligente R2
            </h1>
            <p class="text-gray-400">
                Compara datas de modificação e atualiza apenas o necessário.
                <br>
                Base: <code class="bg-gray-800 px-2 py-1 rounded text-yellow-500 text-sm">https://extensions.io.log.br/renovaweb/...</code>
            </p>
        </header>

        <!-- Controles -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6 border border-gray-700">
            <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                
                <div class="flex-1 w-full">
                    <button id="btnSelectDir" class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-folder-open"></i> Selecionar Pasta Local
                    </button>
                    <p id="selectedPathDisplay" class="mt-2 text-sm text-gray-400 italic">Nenhum diretório selecionado</p>
                </div>

                <div class="flex gap-3">
                    <button id="btnCheckAll" disabled class="disabled:opacity-50 disabled:cursor-not-allowed bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded border border-gray-600">
                        <i class="fa-solid fa-magnifying-glass"></i> Comparar Datas
                    </button>
                    <button id="btnUpdateAll" disabled class="disabled:opacity-50 disabled:cursor-not-allowed bg-yellow-600 hover:bg-yellow-500 text-white py-2 px-4 rounded border border-yellow-600 shadow-lg shadow-yellow-900/50 font-bold">
                        <i class="fa-solid fa-download"></i> Atualizar Desatualizados
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabela de Arquivos -->
        <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse text-sm">
                    <thead>
                        <tr class="bg-gray-900 text-gray-400 uppercase tracking-wider">
                            <th class="p-4 border-b border-gray-700">Arquivo</th>
                            <th class="p-4 border-b border-gray-700 w-48">Data Local</th>
                            <th class="p-4 border-b border-gray-700 w-48">Data Nuvem</th>
                            <th class="p-4 border-b border-gray-700 w-32 text-center">Status</th>
                            <th class="p-4 border-b border-gray-700 w-32 text-center">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="fileListBody" class="divide-y divide-gray-700">
                        <tr>
                            <td colspan="5" class="p-8 text-center text-gray-500">
                                Selecione um diretório para iniciar.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Footer -->
            <div class="p-4 bg-gray-900 border-t border-gray-700 text-xs text-gray-500 flex justify-between">
                <span id="fileCount">0 arquivos</span>
                <span id="logStatus">Aguardando...</span>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const BASE_URL = "https://extensions.io.log.br/renovaweb/";
        
        let rootDirectoryHandle = null;
        let filesData = [];

        // DOM Elements
        const btnSelectDir = document.getElementById('btnSelectDir');
        const btnCheckAll = document.getElementById('btnCheckAll');
        const btnUpdateAll = document.getElementById('btnUpdateAll');
        const fileListBody = document.getElementById('fileListBody');
        const selectedPathDisplay = document.getElementById('selectedPathDisplay');
        const fileCountSpan = document.getElementById('fileCount');
        const logStatusSpan = document.getElementById('logStatus');

        // Events
        btnSelectDir.addEventListener('click', handleDirectorySelection);
        btnCheckAll.addEventListener('click', checkAllRemoteFiles);
        btnUpdateAll.addEventListener('click', updateOutdatedFiles);

        // --- Core Functions ---

        async function handleDirectorySelection() {
            try {
                rootDirectoryHandle = await window.showDirectoryPicker();
                selectedPathDisplay.textContent = `Pasta Raiz: /${rootDirectoryHandle.name}`;
                selectedPathDisplay.classList.add('text-green-400');
                selectedPathDisplay.classList.remove('text-gray-400');

                log("Mapeando arquivos locais...");
                filesData = [];
                renderTableLoading();

                await scanDirectoryRecursive(rootDirectoryHandle, rootDirectoryHandle.name);

                renderTable();
                
                btnCheckAll.disabled = false;
                btnUpdateAll.disabled = true;
                
                log(`Mapeamento concluído. ${filesData.length} arquivos encontrados.`);
                fileCountSpan.textContent = `${filesData.length} arquivos locais`;

            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error(err);
                    alert("Erro: " + err.message);
                }
            }
        }

        async function scanDirectoryRecursive(dirHandle, currentPath) {
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file') {
                    // Obtém metadados do arquivo local imediatamente para ter a data
                    const fileObj = await entry.getFile();
                    const fullPath = `${currentPath}/${entry.name}`;
                    const remoteUrl = `${BASE_URL}${fullPath}`;

                    filesData.push({
                        id: crypto.randomUUID(),
                        localPath: fullPath,
                        handle: entry,
                        remoteUrl: remoteUrl,
                        status: 'pending', // pending, checking, current (ok), outdated (update needed), error, updated
                        localDate: new Date(fileObj.lastModified),
                        remoteDate: null,
                        remoteBlob: null,
                        httpStatus: null
                    });
                } else if (entry.kind === 'directory') {
                    await scanDirectoryRecursive(entry, `${currentPath}/${entry.name}`);
                }
            }
        }

        async function checkAllRemoteFiles() {
            btnCheckAll.disabled = true;
            btnUpdateAll.disabled = true;
            log("Comparando datas com o servidor...");

            // Executa requisições
            const promises = filesData.map(file => checkSingleFile(file));
            await Promise.all(promises);

            renderTable();
            
            // Habilita "Atualizar Tudo" APENAS se houver arquivos 'outdated'
            const hasOutdated = filesData.some(f => f.status === 'outdated');
            if (hasOutdated) {
                btnUpdateAll.disabled = false;
                const count = filesData.filter(f => f.status === 'outdated').length;
                log(`Verificação concluída. ${count} arquivo(s) desatualizado(s).`);
            } else {
                log("Verificação concluída. Tudo atualizado.");
            }
            btnCheckAll.disabled = false;
        }

        async function checkSingleFile(fileObj) {
            fileObj.status = 'checking';
            updateRowStatus(fileObj);

            try {
                // Usamos GET para já pegar o blob se precisar, e pegar os headers
                const response = await fetch(fileObj.remoteUrl, { 
                    method: 'GET',
                    cache: 'no-cache' 
                });

                fileObj.httpStatus = response.status;

                if (response.ok) {
                    fileObj.remoteBlob = await response.blob();
                    
                    // Lógica de Comparação de Datas
                    const lastModifiedHeader = response.headers.get('Last-Modified');
                    
                    if (lastModifiedHeader) {
                        fileObj.remoteDate = new Date(lastModifiedHeader);
                        
                        // Comparação: Se Nuvem > Local = Desatualizado
                        if (fileObj.remoteDate > fileObj.localDate) {
                            fileObj.status = 'outdated';
                        } else {
                            fileObj.status = 'current'; // Local é igual ou mais novo
                        }
                    } else {
                        // Se servidor não mandar data, assumimos que precisa atualizar ou tratamos como erro?
                        // Vamos tratar como outdated por segurança ou current? 
                        // Vou marcar como 'unknown-date' mas permitir update manual
                        fileObj.status = 'outdated'; 
                        console.warn(`Sem header Last-Modified para ${fileObj.localPath}`);
                    }

                } else {
                    fileObj.status = 'error';
                    fileObj.remoteBlob = null;
                }

            } catch (error) {
                console.warn(`Erro fetch ${fileObj.remoteUrl}:`, error);
                fileObj.status = 'error';
                fileObj.httpStatus = 'NET';
            }
            updateRowStatus(fileObj);
        }

        async function updateOutdatedFiles() {
            // Filtra APENAS os desatualizados
            const toUpdate = filesData.filter(f => f.status === 'outdated');
            
            if (toUpdate.length === 0) return;
            
            if(!confirm(`Existem ${toUpdate.length} arquivos mais recentes na nuvem.\nDeseja atualizar seus arquivos locais?`)) {
                return;
            }

            log(`Atualizando ${toUpdate.length} arquivos...`);
            
            for (const file of toUpdate) {
                await writeToFile(file);
            }
            
            log("Sincronização concluída!");
            // Re-verifica para atualizar status visual
            renderTable();
        }

        async function writeToFile(fileObj) {
            try {
                const writable = await fileObj.handle.createWritable();
                await writable.write(fileObj.remoteBlob);
                await writable.close();

                // Atualiza a data local no objeto para refletir a mudança
                // (Na prática o sistema operacional atualiza a data do arquivo, 
                // então marcamos como 'updated' para feedback visual)
                fileObj.status = 'updated';
                fileObj.localDate = new Date(); // Simula nova data local
                updateRowStatus(fileObj);
            } catch (error) {
                console.error("Write error:", error);
                fileObj.status = 'write-error';
                updateRowStatus(fileObj);
            }
        }

        // --- Renderização e Auxiliares ---

        function log(msg) { logStatusSpan.innerText = msg; }

        function formatDate(date) {
            if (!date) return '--';
            return date.toLocaleString('pt-BR', { 
                day: '2-digit', month: '2-digit', year: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        function renderTableLoading() {
            fileListBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-blue-400"><i class="fas fa-spinner fa-2x"></i><br>Lendo disco...</td></tr>`;
        }

        function renderTable() {
            fileListBody.innerHTML = '';
            if (filesData.length === 0) {
                fileListBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">Pasta vazia.</td></tr>`;
                return;
            }
            filesData.forEach(file => {
                const tr = document.createElement('tr');
                tr.id = `row-${file.id}`;
                tr.className = "hover:bg-gray-800/50 transition-colors border-b border-gray-700/50";
                tr.innerHTML = getRowHTML(file);
                fileListBody.appendChild(tr);
            });
        }

        function updateRowStatus(file) {
            const row = document.getElementById(`row-${file.id}`);
            if (row) row.innerHTML = getRowHTML(file);
        }

        function getRowHTML(file) {
            let statusBadge = '<span class="text-gray-600">-</span>';
            let actionBtn = '';
            
            // Lógica de visualização baseada no status
            switch (file.status) {
                case 'checking':
                    statusBadge = '<i class="fas fa-spinner text-blue-400"></i>';
                    break;
                case 'current':
                    statusBadge = '<span class="status-updated text-xs font-bold uppercase"><i class="fa-solid fa-check"></i> Recente</span>';
                    actionBtn = '<span class="text-gray-600 text-xs">Atualizado</span>';
                    break;
                case 'outdated':
                    statusBadge = '<span class="status-outdated text-xs font-bold uppercase"><i class="fa-solid fa-clock"></i> Antigo</span>';
                    actionBtn = `<button onclick="triggerSingleUpdate('${file.id}')" class="bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-1 rounded text-xs transition-colors shadow">Atualizar</button>`;
                    break;
                case 'updated':
                    statusBadge = '<span class="text-blue-400 text-xs font-bold uppercase">Sucesso</span>';
                    actionBtn = '<span class="text-blue-500 text-xs"><i class="fa-solid fa-check-double"></i> Feito</span>';
                    break;
                case 'error':
                    statusBadge = `<span class="status-error text-xs font-bold">ERRO ${file.httpStatus || ''}</span>`;
                    break;
                case 'write-error':
                    statusBadge = '<span class="text-red-500 text-xs font-bold">Erro Disco</span>';
                    break;
            }

            // Destaca a data remota se ela for mais nova
            const remoteDateClass = (file.remoteDate > file.localDate) ? "text-yellow-400 font-bold" : "text-gray-400";

            return `
                <td class="p-4 font-mono text-gray-300 break-all text-xs">
                    <div class="font-bold text-sm">${file.localPath.split('/').pop()}</div>
                    <div class="text-gray-500">${file.localPath}</div>
                </td>
                <td class="p-4 text-xs text-gray-400 font-mono">${formatDate(file.localDate)}</td>
                <td class="p-4 text-xs ${remoteDateClass} font-mono">${formatDate(file.remoteDate)}</td>
                <td class="p-4 text-center">${statusBadge}</td>
                <td class="p-4 text-center">${actionBtn}</td>
            `;
        }

        window.triggerSingleUpdate = async (id) => {
            const file = filesData.find(f => f.id === id);
            if (file) await writeToFile(file);
        };
    </script>
</body>
</html>